<div class="container">
  <div class="canvas-container">
    <!-- Three.js se renderizar√° aqu√≠ -->
  </div>

  <!-- Panel derecho eliminado: la UI principal pasa a m√≥dulos flotantes -->

  <!-- Capa de carga minimal (centrada) -->
  <div *ngIf="loadingFirstFrame" class="loading-badge glass-tiny">{{loadingProgress}}% ‚Ä¢ {{firstFrameReceived}}/{{firstFrameSatCount}}</div>


<!-- Panel flotante de b√∫squeda / constelaciones (redise√±o moderno) -->
<div class="search-panel glass-elevated" [class.minimized]="searchPanelMinimized">
  <button class="panel-minimize-btn" (click)="toggleSearchPanelMinimized(true)" aria-label="Minimize" title="Minimize">‚Äì</button>
  <div class="finder-minimized" (click)="toggleSearchPanelMinimized(false)">
    <div class="mini-title">SAT Finder</div>
    <div class="mini-desc">Track satellites across constellations</div>
    <div class="mini-expand">Show more</div>
  </div>
  <div class="finder-body">
    <div class="finder-header">
      <div class="finder-title">SAT Finder</div>
      <div class="finder-subtitle">Track and select satellites</div>
    </div>
  <div class="finder-field">
    <label for="constellationSel">Constellation</label>
    <div class="constellation-dropdown" [class.open]="showConstellationDropdown">
      <button type="button" class="constellation-trigger" (click)="toggleConstellationDropdown()">
        <span class="trigger-text">{{ tle.getConstellationLabel(selectedConstellation) }}</span>
        <span class="trigger-chevron">‚ñæ</span>
      </button>
      <div class="constellation-menu" *ngIf="showConstellationDropdown" (scroll)="onConstellationScroll($event)">
        <div class="constellation-item" *ngFor="let c of tle.getAvailableConstellations()" [class.active]="c===selectedConstellation" (click)="onPickConstellation(c)">
          <span class="constellation-label">{{ tle.getConstellationLabel(c) }}</span>
        </div>
      </div>
    </div>
  </div>
  <div class="finder-field">
    <label for="satSearchInput">Name or NORAD ID</label>
    <div class="input-wrapper">
      <span class="icon-search" aria-hidden="true">üîç</span>
  <input id="satSearchInput" type="text" autocomplete="off" placeholder="Ex: 55342 or STARLINK" [(ngModel)]="searchQuery" (input)="onSearchChange()" (focus)="onSearchFocus()" (click)="onSearchFocus()" />
      <button *ngIf="searchQuery" class="clear-btn" (click)="searchQuery=''; onSearchChange();" type="button" aria-label="Clear">‚úï</button>
  <div class="search-dropdown" *ngIf="showSearchDropdown" (scroll)="onSearchScroll($event)">
        <div class="search-item" *ngFor="let r of filteredResults" (click)="pickSearchResult(r.index)" [title]="r.label">{{r.label}}</div>
        <div class="no-results" *ngIf="filteredResults.length===0">No results</div>
      </div>
    </div>
  </div>
  <div class="finder-stats">
    <span>{{filteredResults.length}} results</span>
    <span class="divider">/</span>
    <span>{{tle.getAllSatrecs().length}} satellites</span>
  </div>
  <div class="view-mode-buttons">
    <button class="view-btn" [class.active]="viewMode==='global'" (click)="activateGlobalView()" title="Global view">üåê</button>
    <button class="view-btn" [disabled]="!hasSelectedSatellite" [class.disabled]="!hasSelectedSatellite" [class.active]="viewMode==='satellite'" (click)="activateSatelliteView()" title="Satellite view (requires selection)">üõ∞Ô∏è</button>
  </div>
  </div>
</div>

<!-- Bot√≥n de configuraci√≥n -->
 <div class="Config-dock">
  <button class="config-toggle" (click)="toggleConfigPanel()" title="Configuration">‚öôÔ∏è</button>
</div>
<!-- Tray configuraci√≥n horizontal -->
<div class="config-tray" *ngIf="showConfigPanel">
  <div class="tray-header">
    <span class="tray-title">Configuration</span>
    <button class="close-tray" (click)="toggleConfigPanel()" aria-label="Close">‚úï</button>
  </div>
  <div class="tray-columns">
    <!-- Columna toggles b√°sicos -->
    <div class="tray-col">
      <div class="col-title">Layers</div>
      <label class="chk-line"><input type="checkbox" [(ngModel)]="cfg.showGrid" (change)="applyConfig()" /> <span>Earth grid</span></label>
      <label class="chk-line"><input type="checkbox" [(ngModel)]="cfg.showAxes" (change)="applyConfig()" /> <span>XYZ axes</span></label>
      <label class="chk-line"><input type="checkbox" [(ngModel)]="cfg.showLabels" (change)="applyConfig()" /> <span>Extra labels</span></label>
    </div>
    <!-- Columna colores -->
    <div class="tray-col">
      <div class="col-title">Colors</div>
      <div class="mini-label-inline">Satellites</div>
      <div class="color-row tight">
        <div *ngFor="let c of satelliteColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.satColor" (click)="setSatelliteColor(c)"></div>
        <div class="color-swatch custom" [ngStyle]="{background:customSatColor}" title="Personalizado">
          <input type="color" [(ngModel)]="customSatColor" (change)="setCustomSatelliteColor()" />
        </div>
      </div>
      <div class="mini-label-inline" style="margin-top:10px;">Orbit</div>
      <div class="color-row tight">
        <div *ngFor="let c of orbitColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.orbitColor" (click)="setOrbitColor(c)"></div>
        <div class="color-swatch custom" [ngStyle]="{background:customOrbitColor}" title="Custom">
          <input type="color" [(ngModel)]="customOrbitColor" (change)="setCustomOrbitColor()" />
        </div>
      </div>
    </div>
    <!-- Columna Tierra / Render -->
    <div class="tray-col wide">
      <div class="col-title">Earth / Render</div>
      <div class="earth-mode-row">
        <label class="mini-label-inline">Mode</label>
        <select #earthModeSel (change)="onEarthModeChange(earthModeSel.value)" [value]="earthMode">
          <option value="classic">Classic</option>
          <option value="glb">GLB</option>
        </select>
      </div>
      <div *ngIf="earthMode==='glb'" class="pbr-block">
        <label class="chk-line small"><input type="checkbox" [checked]="glbPbrMode" (change)="glbPbrMode=!glbPbrMode; setEarthMode('glb')" /> <span>PBR (HDR)</span></label>
        <div *ngIf="!glbPbrMode" class="hint-line">Flat: no lights / HDR</div>
        <div *ngIf="glbPbrMode" class="pbr-sliders">
          <label>HDR Int <input type="range" min="0" max="3" step="0.05" [(ngModel)]="pbrEnvMapIntensity" (change)="onPbrParamsChange()" /> <span>{{pbrEnvMapIntensity | number:'1.2-2'}}</span></label>
          <label>Rough Œî <input type="range" min="-0.8" max="0.8" step="0.01" [(ngModel)]="pbrRoughnessDelta" (change)="onPbrParamsChange()" /> <span>{{pbrRoughnessDelta | number:'1.2-2'}}</span></label>
          <label>Metal Œî <input type="range" min="-0.5" max="0.5" step="0.01" [(ngModel)]="pbrMetalnessDelta" (change)="onPbrParamsChange()" /> <span>{{pbrMetalnessDelta | number:'1.2-2'}}</span></label>
          <div class="pbr-actions">
            <button (click)="resetPbrAdjustments()" class="mini-btn">Reset PBR</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- M√≥dulo detalle sat√©lite seleccionado -->
<div *ngIf="hasSelectedSatellite">
  <!-- Mini header colapsado -->
  <div class="sat-mini-header" *ngIf="satelliteInfoPanel.collapsed" (click)="toggleSatelliteInfoPanel()" [ngStyle]="{top: satelliteInfoPanel.miniTopPx + 'px'}">
    <span class="mini-icon">‚ÑπÔ∏è</span>
    <span class="mini-title">{{ satelliteInfoPanel.currentName }} <span class="mini-id" *ngIf="satelliteInfoPanel.currentNorad">#{{satelliteInfoPanel.currentNorad}}</span></span>
    <span class="mini-expand">‚Ä∫</span>
    <button class="mini-close" (click)="onCloseSatellite($event)" aria-label="Close">‚úï</button>
  </div>
  <!-- Panel expandido -->
  <div class="sat-detail-panel" [class.collapsed]="satelliteInfoPanel.collapsed" #satPanel>
    <button class="sat-panel-close-btn" (click)="onCloseSatellite($event)" title="Close" aria-label="Close">‚úï</button>
    <button class="sat-panel-min-btn" (click)="onClickSatellitePanelMin($event)" title="Minimize" aria-label="Minimize">‚Äì</button>
    
    <!-- T√≠tulo del sat√©lite - visible en todos los tabs -->
    <div class="sat-panel-header" *ngIf="satelliteInfoPanel.currentName">
      <div class="sat-name-display">
        <span class="sat-name">{{ satelliteInfoPanel.currentName }}</span>
        <span class="sat-id" *ngIf="satelliteInfoPanel.currentNorad">#{{ satelliteInfoPanel.currentNorad }}</span>
      </div>
    </div>
    
    <div class="sat-detail-inner" *ngIf="!satelliteInfoPanel.collapsed">
      <aside class="sat-tabs">
        <button class="sat-tab" *ngFor="let t of satelliteInfoPanel.tabs" [class.active]="satelliteInfoPanel.activeTab===t.id" (click)="setSatelliteInfoTab(t.id)">{{t.label}}</button>
      </aside>
      <section class="sat-tab-content">
        <div *ngIf="satelliteInfoPanel.activeTab==='summary'" class="tab-view fade-in"><app-sat-summary [satIndex]="selectedSatelliteIndex"></app-sat-summary></div>
        <div *ngIf="satelliteInfoPanel.activeTab==='info'" class="tab-view fade-in"><app-sat-info [satIndex]="selectedSatelliteIndex"></app-sat-info></div>
        <div *ngIf="satelliteInfoPanel.activeTab==='tle'" class="tab-view fade-in"><app-sat-tle [satIndex]="selectedSatelliteIndex"></app-sat-tle></div>
        <div *ngIf="satelliteInfoPanel.activeTab==='charts'" class="tab-view fade-in"><app-sat-charts [satIndex]="selectedSatelliteIndex"></app-sat-charts></div>
        <div *ngIf="satelliteInfoPanel.activeTab==='position'" class="tab-view fade-in"><app-sat-position [satIndex]="selectedSatelliteIndex"></app-sat-position></div>
        <div *ngIf="satelliteInfoPanel.activeTab==='hardware'" class="tab-view fade-in"><app-sat-hardware [satIndex]="selectedSatelliteIndex"></app-sat-hardware></div>
      </section>
    </div>
  </div>
</div>

<!-- Banner superior de navegaci√≥n -->
<div class="top-banner">
  <div class="brand">
    <img src="assets/Logo.png" alt="3D Constellation Link Tracker" class="brand-logo">
    <span class="brand-text">3DConstellationTracker<span class="accent">.Space</span></span>
  </div>
  <nav class="nav-links">
    <a href="#" class="nav-item">About</a>
    <a href="#" class="nav-item">Constellations</a>
    <a href="#" class="nav-item">Types</a>
    <a href="#" class="nav-item">Functions</a>
    <a href="#" class="nav-item">Insights</a>
    <a href="#" class="nav-item">More</a>
  </nav>
  <div class="banner-extra">Alpha Version ‚Ä¢ Real Time ‚Ä¢ Demo</div>
</div>

<!-- Dock vertical derecho -->
<div class="module-dock">
  <button class="dock-btn" [class.active]="openModule==='geo'" (click)="toggleModule('geo')" title="UE Location">üìç</button>
  <button class="dock-btn" [class.active]="openModule==='link'" (click)="toggleModule('link')" title="Link Parameters">üì°</button>
  <button class="dock-btn" [class.active]="openModule==='metrics'" (click)="toggleModule('metrics')" title="Metrics">üìä</button>
</div>

<!-- Panel flotante m√≥dulo GEO -->
<div class="module-flyout" *ngIf="openModule==='geo'">
  <div class="flyout-header">
    <div>
      <div class="flyout-title">Geo Locator</div>
      <div class="flyout-sub">UE Position</div>
    </div>
    <button class="close-flyout" (click)="toggleModule('geo')">‚úï</button>
  </div>
  <div class="flyout-section">
    <div class="mini-label">Coordinates</div>
    <div class="geo-row compact">
      <label>Lat</label>
      <input type="number" [(ngModel)]="userLat" (change)="updateUserPosition()" min="-90" max="90" step="0.0001" />
      <label>Lon</label>
      <input type="number" [(ngModel)]="userLon" (change)="updateUserPosition()" min="-180" max="180" step="0.0001" />
    </div>
    <div class="mini-label" style="margin-top:10px;">Auto (GPS)</div>
    <div class="soon-box">Coming Soon</div>
    <div class="mini-label" style="margin-top:14px;">Quick City</div>
    <div class="city-search-wrapper">
      <input type="text" placeholder="Search city (ex: Madrid)" [(ngModel)]="cityQuery" (input)="onCitySearchChange()" (focus)="onCitySearchFocus()" />
      <button *ngIf="cityQuery" class="clear-btn-mini" (click)="cityQuery=''; onCitySearchChange();" type="button">‚úï</button>
    </div>
  </div>
</div>

<!-- Panel futuros (placeholders) -->
<div class="module-flyout" *ngIf="openModule==='link'">
  <div class="flyout-header"><div class="flyout-title">Link Parameters</div><button class="close-flyout" (click)="toggleModule('link')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) Here will be elevation parameters, hysteresis, cooldown, throughput target, etc.</div>
</div>
<div class="module-flyout" *ngIf="openModule==='metrics'">
  <div class="flyout-header"><div class="flyout-title">Metrics</div><button class="close-flyout" (click)="toggleModule('metrics')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) Selected satellite KPIs, average latency, jitter, recent handovers.</div>
</div>
<div class="module-flyout" *ngIf="openModule==='config'">
  <div class="flyout-header"><div class="flyout-title">Configuration</div><button class="close-flyout" (click)="toggleModule('config')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) Global visual options, Earth modes, colors and toggles.</div>
</div>

<!-- Dropdown flotante ciudades fuera del flujo para evitar scroll interno -->
<div class="city-dropdown floating" *ngIf="showCityDropdown" [ngStyle]="{left: cityDropdownX+'px', top: cityDropdownY+'px', width: cityDropdownWidth+'px'}" (scroll)="onCityScroll($event)">
  <div class="city-item" *ngFor="let c of filteredCities" (click)="pickCity(c)">
    <span class="city-name">{{c.name}}</span>
    <span class="city-coord">{{c.lat.toFixed(2)}}, {{c.lon.toFixed(2)}}</span>
  </div>
  <div class="no-results" *ngIf="filteredCities.length===0">No results</div>
</div>