<div class="container">
  <div class="canvas-container">
    <!-- Three.js se renderizar√° aqu√≠ -->
  </div>

  <!-- Panel derecho eliminado: la UI principal pasa a m√≥dulos flotantes -->

  <!-- Capa de carga minimal (centrada) -->
  <div *ngIf="loadingFirstFrame" class="loading-badge glass-tiny">{{loadingProgress}}% ‚Ä¢ {{firstFrameReceived}}/{{firstFrameSatCount}}</div>


<!-- Panel flotante de b√∫squeda / constelaciones (redise√±o moderno) -->
<div class="search-panel glass-elevated">
  <div class="finder-header">
    <div class="finder-title">SAT Finder</div>
    <div class="finder-subtitle">Rastrea y selecciona sat√©lites</div>
  </div>
  <div class="finder-field">
    <label for="constellationSel">Constelaci√≥n</label>
    <div class="select-wrapper">
      <select id="constellationSel" [(ngModel)]="selectedConstellation" (click)="onConstellationSelectClick()" (change)="changeConstellation(selectedConstellation)">
        <option *ngFor="let c of tle.getAvailableConstellations()" [value]="c">{{ tle.getConstellationLabel(c) }}</option>
      </select>
      <span class="chevron">‚ñæ</span>
    </div>
  </div>
  <div class="finder-field">
    <label for="satSearchInput">Nombre o NORAD ID</label>
    <div class="input-wrapper">
      <span class="icon-search" aria-hidden="true">üîç</span>
  <input id="satSearchInput" type="text" autocomplete="off" placeholder="Ej: 55342 o STARLINK" [(ngModel)]="searchQuery" (input)="onSearchChange()" (focus)="onSearchFocus()" (click)="onSearchFocus()" />
      <button *ngIf="searchQuery" class="clear-btn" (click)="searchQuery=''; onSearchChange();" type="button" aria-label="Limpiar">‚úï</button>
  <div class="search-dropdown" *ngIf="showSearchDropdown" (scroll)="onSearchScroll($event)">
        <div class="search-item" *ngFor="let r of filteredResults" (click)="pickSearchResult(r.index)" [title]="r.label">{{r.label}}</div>
        <div class="no-results" *ngIf="filteredResults.length===0">Sin resultados</div>
      </div>
    </div>
  </div>
  <div class="finder-stats">
    <span>{{filteredResults.length}} resultados</span>
    <span class="divider">/</span>
    <span>{{tle.getAllSatrecs().length}} sat√©lites</span>
  </div>
</div>

<!-- Bot√≥n de configuraci√≥n -->
<div class="config-toggle" (click)="toggleConfigPanel()" title="Configuraci√≥n">
  ‚öôÔ∏è
</div>

<!-- Panel configuraci√≥n -->
<div class="config-panel" *ngIf="showConfigPanel">
  <h3>Configuraci√≥n</h3>
  <div class="config-options">
    <div class="config-option">
      <input type="checkbox" id="cfgGrid" [(ngModel)]="cfg.showGrid" (change)="applyConfig()" />
      <label for="cfgGrid">Mostrar grid terrestre</label>
    </div>
    <div class="config-option">
      <input type="checkbox" id="cfgAxes" [(ngModel)]="cfg.showAxes" (change)="applyConfig()" />
      <label for="cfgAxes">Mostrar ejes XYZ</label>
    </div>
    <div class="config-option">
      <input type="checkbox" id="cfgLabels" [(ngModel)]="cfg.showLabels" (change)="applyConfig()" />
      <label for="cfgLabels">Mostrar etiquetas (excepto siempre la del seleccionado)</label>
    </div>
    <div class="config-option" style="flex-direction:column; align-items:flex-start;">
      <label style="cursor:default;">Color sat√©lites</label>
      <div class="color-row">
        <div *ngFor="let c of satelliteColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.satColor" (click)="setSatelliteColor(c)" title="{{c}}"></div>
        <div class="color-swatch" [ngStyle]="{background:customSatColor, border:'2px dashed rgba(255,255,255,0.5)'}" title="Personalizado">
          <input type="color" [(ngModel)]="customSatColor" (change)="setCustomSatelliteColor()" style="opacity:0; width:100%; height:100%; cursor:pointer;" />
        </div>
      </div>
    </div>
    <div class="config-option" style="flex-direction:column; align-items:flex-start;">
      <label style="cursor:default;">Color √≥rbita</label>
      <div class="color-row">
        <div *ngFor="let c of orbitColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.orbitColor" (click)="setOrbitColor(c)" title="{{c}}"></div>
        <div class="color-swatch" [ngStyle]="{background:customOrbitColor, border:'2px dashed rgba(255,255,255,0.5)'}" title="Personalizado">
          <input type="color" [(ngModel)]="customOrbitColor" (change)="setCustomOrbitColor()" style="opacity:0; width:100%; height:100%; cursor:pointer;" />
        </div>
      </div>
    </div>
    <hr style="width:100%; border:none; border-top:1px solid rgba(255,255,255,0.1); margin:4px 0;" />
    <h4 style="margin:4px 0 4px; font-size:0.8rem; opacity:0.8;">Tierra / Render</h4>
    <div class="config-option" style="flex-direction:column; align-items:flex-start;">
    <label>Modo Tierra</label>
  <select #earthModeSel (change)="onEarthModeChange(earthModeSel.value)" [value]="earthMode" style="width:100%;">
        <option value="classic">Cl√°sico (Textura)</option>
        <option value="glb">GLB</option>
      </select>
    </div>
    <div class="config-option" *ngIf="earthMode==='glb'" style="flex-direction:column; align-items:flex-start; gap:4px;">
  <label><input type="checkbox" [checked]="glbPbrMode" (change)="glbPbrMode=!glbPbrMode; setEarthMode('glb')" /> PBR (HDR + materiales f√≠sicos)</label>
  <!-- Auto-rotar y slider de velocidad eliminados: rotaci√≥n siempre real -->
  <!-- Exposici√≥n fija (2.0) en modo GLB PBR: control eliminado -->
      <div *ngIf="!glbPbrMode" style="font-size:0.6rem; opacity:0.7;">Modo plano: ignora luces / HDR</div>
  <!-- Controles de brillo/contraste eliminados -->
      <div *ngIf="glbPbrMode" class="config-option" style="flex-direction:column; align-items:flex-start; width:100%; margin-top:6px;">
        <label style="cursor:default; font-size:0.7rem; opacity:0.9;">PBR Avanzado</label>
        <label style="display:flex; align-items:center; width:100%; gap:6px;">HDR Int
          <input type="range" min="0" max="3" step="0.05" [(ngModel)]="pbrEnvMapIntensity" (change)="onPbrParamsChange()" style="flex:1;" />
          <span style="font-size:0.65rem; width:46px; text-align:right;">{{pbrEnvMapIntensity | number:'1.2-2'}}</span>
        </label>
        <label style="display:flex; align-items:center; width:100%; gap:6px;">Rough Œî
          <input type="range" min="-0.8" max="0.8" step="0.01" [(ngModel)]="pbrRoughnessDelta" (change)="onPbrParamsChange()" style="flex:1;" />
          <span style="font-size:0.65rem; width:46px; text-align:right;">{{pbrRoughnessDelta | number:'1.2-2'}}</span>
        </label>
        <label style="display:flex; align-items:center; width:100%; gap:6px;">Metal Œî
          <input type="range" min="-0.5" max="0.5" step="0.01" [(ngModel)]="pbrMetalnessDelta" (change)="onPbrParamsChange()" style="flex:1;" />
          <span style="font-size:0.65rem; width:46px; text-align:right;">{{pbrMetalnessDelta | number:'1.2-2'}}</span>
        </label>
  <!-- Rim light eliminado completamente -->
        <div style="display:flex; gap:6px; width:100%;">
          <button (click)="resetPbrAdjustments()" style="flex:1; padding:2px 4px; font-size:0.65rem;">Reset PBR</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Banner superior de navegaci√≥n -->
<div class="top-banner">
  <div class="brand">Handover<span class="accent">.viz</span></div>
  <nav class="nav-links">
    <a href="#" class="nav-item">Acerca</a>
    <a href="#" class="nav-item">Constelaciones</a>
    <a href="#" class="nav-item">Tipos</a>
    <a href="#" class="nav-item">Funciones</a>
    <a href="#" class="nav-item">Insights</a>
    <a href="#" class="nav-item">M√°s</a>
  </nav>
  <div class="banner-extra">Beta ‚Ä¢ Tiempo real ‚Ä¢ Demo</div>
</div>

<!-- Dock vertical derecho -->
<div class="module-dock">
  <button class="dock-btn" [class.active]="openModule==='geo'" (click)="toggleModule('geo')" title="Localizaci√≥n UE">üìç</button>
  <button class="dock-btn" [class.active]="openModule==='link'" (click)="toggleModule('link')" title="Par√°metros enlace">üì°</button>
  <button class="dock-btn" [class.active]="openModule==='metrics'" (click)="toggleModule('metrics')" title="M√©tricas">üìä</button>
  <button class="dock-btn" [class.active]="openModule==='config'" (click)="toggleModule('config')" title="Configuraci√≥n">‚öôÔ∏è</button>
</div>

<!-- Panel flotante m√≥dulo GEO -->
<div class="module-flyout" *ngIf="openModule==='geo'">
  <div class="flyout-header">
    <div>
      <div class="flyout-title">Geo Locator</div>
      <div class="flyout-sub">Posici√≥n UE</div>
    </div>
    <button class="close-flyout" (click)="toggleModule('geo')">‚úï</button>
  </div>
  <div class="flyout-section">
    <div class="mini-label">Coordenadas</div>
    <div class="geo-row compact">
      <label>Lat</label>
      <input type="number" [(ngModel)]="userLat" (change)="updateUserPosition()" min="-90" max="90" step="0.0001" />
      <label>Lon</label>
      <input type="number" [(ngModel)]="userLon" (change)="updateUserPosition()" min="-180" max="180" step="0.0001" />
    </div>
    <div class="mini-label" style="margin-top:10px;">Auto (GPS)</div>
    <div class="soon-box">Pr√≥ximamente</div>
    <div class="mini-label" style="margin-top:14px;">Ciudad r√°pida</div>
    <div class="city-search-wrapper">
      <input type="text" placeholder="Buscar ciudad (ej: Madrid)" [(ngModel)]="cityQuery" (input)="onCitySearchChange()" (focus)="onCitySearchFocus()" />
      <button *ngIf="cityQuery" class="clear-btn-mini" (click)="cityQuery=''; onCitySearchChange();" type="button">‚úï</button>
    </div>
  </div>
</div>

<!-- Panel futuros (placeholders) -->
<div class="module-flyout" *ngIf="openModule==='link'">
  <div class="flyout-header"><div class="flyout-title">Par√°metros Enlace</div><button class="close-flyout" (click)="toggleModule('link')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) Aqu√≠ ir√°n par√°metros de elevaci√≥n, hist√©resis, cooldown, throughput target, etc.</div>
</div>
<div class="module-flyout" *ngIf="openModule==='metrics'">
  <div class="flyout-header"><div class="flyout-title">M√©tricas</div><button class="close-flyout" (click)="toggleModule('metrics')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) KPIs de sat√©lite seleccionado, latencia media, jitter, handovers recientes.</div>
</div>
<div class="module-flyout" *ngIf="openModule==='config'">
  <div class="flyout-header"><div class="flyout-title">Configuraci√≥n</div><button class="close-flyout" (click)="toggleModule('config')">‚úï</button></div>
  <div class="placeholder-block">(Placeholder) Opciones visuales globales, modos de Tierra, colores y toggles.</div>
</div>

<!-- Dropdown flotante ciudades fuera del flujo para evitar scroll interno -->
<div class="city-dropdown floating" *ngIf="showCityDropdown" [ngStyle]="{left: cityDropdownX+'px', top: cityDropdownY+'px', width: cityDropdownWidth+'px'}" (scroll)="onCityScroll($event)">
  <div class="city-item" *ngFor="let c of filteredCities" (click)="pickCity(c)">
    <span class="city-name">{{c.name}}</span>
    <span class="city-coord">{{c.lat.toFixed(2)}}, {{c.lon.toFixed(2)}}</span>
  </div>
  <div class="no-results" *ngIf="filteredCities.length===0">Sin resultados</div>
</div>