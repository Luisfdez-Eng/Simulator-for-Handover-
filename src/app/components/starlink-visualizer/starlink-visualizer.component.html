<div class="container">
  <div class="canvas-container">
    <!-- Three.js se renderizará aquí -->
  </div>

  <div class="overlay">
    <div class="header">
      <h1>Starlink Handover Visualizer</h1>
      <p>Satélites activos: {{ tle.getAllSatrecs().length }}</p>
  <p style="font-size:0.75rem; opacity:0.75; margin-top:-4px;">Constelación: {{ tle.getConstellationLabel(selectedConstellation) }}</p>
    </div>

    <div *ngIf="loadingFirstFrame" class="loading-overlay">
      <div class="loading-content">
        <p>Cargando satélites... {{loadingProgress}}%</p>
        <p>Satélites propagados: {{firstFrameReceived}} / {{firstFrameSatCount}}</p>
        <p *ngIf="loadingElapsedMs > 0">Tiempo de carga: {{loadingElapsedMs | number:'1.0-0'}} ms</p>
        <progress [value]="loadingProgress" max="100"></progress>
      </div>
    </div>

    <div class="metrics-panel" *ngIf="currentMetrics">
      <h2>Métricas del satélite actual</h2>
      <div class="metric">
        <label>Elevación:</label>
        <span>{{ currentMetrics.elevation | number:'1.1-1' }}°</span>
      </div>
      <div class="metric">
        <label>RSSI:</label>
        <span>{{ currentMetrics.rssi | number:'1.1-1' }} dBm</span>
      </div>
      <div class="metric">
        <label>SNR:</label>
        <span>{{ currentMetrics.snr | number:'1.1-1' }} dB</span>
      </div>
      <div class="metric">
        <label>Throughput:</label>
        <span>{{ currentMetrics.throughput | number:'1.1-1' }} Mbps</span>
      </div>
      <div class="metric">
        <label>Latencia:</label>
        <span>{{ currentMetrics.latency | number:'1.1-1' }} ms</span>
      </div>
    </div>

    <div class="controls-panel">
      <h2>Controles</h2>
      <div class="control-group">
        <label>Posición del Usuario</label>
        <div class="coordinates">
          <input type="number" [(ngModel)]="userLat" (change)="updateUserPosition()" placeholder="Latitud" min="-90"
            max="90">
          <input type="number" [(ngModel)]="userLon" (change)="updateUserPosition()" placeholder="Longitud" min="-180"
            max="180">
        </div>
      </div>

      <div class="control-group">
        <label>Parámetros de Handover</label>
        <div class="slider">
          <label>Histéresis (°)</label>
          <input type="range" [(ngModel)]="hysteresis" min="0" max="10" step="0.5">
          <span>{{ hysteresis }}°</span>
        </div>
        <div class="slider">
          <label>Cooldown (s)</label>
          <input type="range" [(ngModel)]="cooldown" min="0" max="60" step="5">
          <span>{{ cooldown }}s</span>
        </div>
      </div>

      <div class="control-group">
        <label>Velocidad del tiempo</label>
        <div class="slider">
          <label>Multiplicador de tiempo (x)</label>
          <input type="range" [(ngModel)]="timeMultiplier" min="0.1" max="50" step="0.1">
          <span>{{ timeMultiplier | number:'1.1-1' }}x</span>
        </div>
    </div>
  </div>
</div>

<!-- Panel flotante de búsqueda / constelaciones -->
<div class="search-panel">
  <h2>SAT Finder</h2>
  <div class="constellation-select">
    <label>Constelación</label>
  <select [(ngModel)]="selectedConstellation" (click)="onConstellationSelectClick()" (change)="changeConstellation(selectedConstellation)">
      <option *ngFor="let c of tle.getAvailableConstellations()" [value]="c">{{ tle.getConstellationLabel(c) }}</option>
    </select>
  </div>
  <div class="sat-search">
    <input type="text" placeholder="Nombre o NORAD ID" [(ngModel)]="searchQuery" (input)="onSearchChange()" (focus)="onSearchChange()" />
    <div class="search-dropdown" *ngIf="showSearchDropdown">
      <div class="search-item" *ngFor="let r of filteredResults" (click)="pickSearchResult(r.index)">{{r.label}}</div>
      <div class="no-results" *ngIf="filteredResults.length===0">Sin resultados</div>
    </div>
  </div>
  <div class="finder-hint">Resultados: {{filteredResults.length}} / {{tle.getAllSatrecs().length}}</div>
</div>

<!-- Botón de configuración -->
<div class="config-toggle" (click)="toggleConfigPanel()" title="Configuración">
  ⚙️
</div>

<!-- Panel configuración -->
<div class="config-panel" *ngIf="showConfigPanel">
  <h3>Configuración</h3>
  <div class="config-options">
    <div class="config-option">
      <input type="checkbox" id="cfgGrid" [(ngModel)]="cfg.showGrid" (change)="applyConfig()" />
      <label for="cfgGrid">Mostrar grid terrestre</label>
    </div>
    <div class="config-option">
      <input type="checkbox" id="cfgAxes" [(ngModel)]="cfg.showAxes" (change)="applyConfig()" />
      <label for="cfgAxes">Mostrar ejes XYZ</label>
    </div>
    <div class="config-option">
      <input type="checkbox" id="cfgLabels" [(ngModel)]="cfg.showLabels" (change)="applyConfig()" />
      <label for="cfgLabels">Mostrar etiquetas (excepto siempre la del seleccionado)</label>
    </div>
    <div class="config-option" style="flex-direction:column; align-items:flex-start;">
      <label style="cursor:default;">Color satélites</label>
      <div class="color-row">
        <div *ngFor="let c of satelliteColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.satColor" (click)="setSatelliteColor(c)" title="{{c}}"></div>
        <div class="color-swatch" [ngStyle]="{background:customSatColor, border:'2px dashed rgba(255,255,255,0.5)'}" title="Personalizado">
          <input type="color" [(ngModel)]="customSatColor" (change)="setCustomSatelliteColor()" style="opacity:0; width:100%; height:100%; cursor:pointer;" />
        </div>
      </div>
    </div>
    <div class="config-option" style="flex-direction:column; align-items:flex-start;">
      <label style="cursor:default;">Color órbita</label>
      <div class="color-row">
        <div *ngFor="let c of orbitColorPalette" class="color-swatch" [ngStyle]="{background:c}" [class.selected]="c===cfg.orbitColor" (click)="setOrbitColor(c)" title="{{c}}"></div>
        <div class="color-swatch" [ngStyle]="{background:customOrbitColor, border:'2px dashed rgba(255,255,255,0.5)'}" title="Personalizado">
          <input type="color" [(ngModel)]="customOrbitColor" (change)="setCustomOrbitColor()" style="opacity:0; width:100%; height:100%; cursor:pointer;" />
        </div>
      </div>
    </div>
  </div>
</div>